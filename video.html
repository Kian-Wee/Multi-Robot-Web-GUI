<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0"
    />

    <title>ROS Video</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/semantic-ui@2.5.0/dist/semantic.min.css">
    <script
    src="https://code.jquery.com/jquery-3.1.1.min.js"
    integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="
    crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/semantic-ui@2.5.0/dist/semantic.min.js"></script>
    <link rel="stylesheet" type="text/css" href="semantic/dist/semantic.min.css">

<script type="text/javascript" src="http://static.robotwebtools.org/EventEmitter2/current/eventemitter2.min.js"></script>
<script type="text/javascript" src="http://static.robotwebtools.org/roslibjs/current/roslib.min.js"></script>

<script type="text/javascript" type="text/javascript">

  var ros = new ROSLIB.Ros({
    url : 'ws://localhost:9090'
  });

  ros.on('connection', function() {
    console.log('Connected to websocket server.');
  });

  ros.on('error', function(error) {
    console.log('Error connecting to websocket server: ', error);
  });

  ros.on('close', function() {
    console.log('Connection to websocket server closed.');
  });

  // UAV Position
  var uav1poslistener = new ROSLIB.Topic({
    ros : ros,
    name : '/mavros/local_position/pose',
    messageType : 'geometry_msgs/PoseStamped'
  });

  uav1poslistener.subscribe(function(message) {
    //console.log('Received message on ' + uav1poslistener.name + ': ' + message.pose.position.x);
    document.getElementById('posx').innerHTML = String(message.pose.position.x.toFixed(2));
    document.getElementById('posy').innerHTML = String(message.pose.position.y.toFixed(2));
    document.getElementById('posz').innerHTML = String(message.pose.position.z.toFixed(2));
    //uav1poslistener.unsubscribe();
  });

  // UAV Battery
  var uav1batlistener = new ROSLIB.Topic({
    ros : ros,
    name : '/mavros/battery',
    messageType : 'sensor_msgs/BatteryState'
  });

  uav1batlistener.subscribe(function(message) {
    //console.log('Received message on ' + uav1batlistener.name + ': ' + message.cell_voltage);
    var average = message.cell_voltage.reduce((a, b) => a + b, 0) / message.cell_voltage.length;
    var batper = (average-3.2)/(4.2-3.2) * 100
    document.getElementById('battery').innerHTML = String(batper.toFixed(2));
    //uav1batlistener.unsubscribe();
  });

  // UAV State
  var uav1statelistener = new ROSLIB.Topic({
    ros : ros,
    name : '/mavros/state',
    messageType : 'mavros_msgs/State'
  });

  uav1statelistener.subscribe(function(message) {
    //console.log('Received message on ' + uav1statelistener.name + ': ' + message.mode);
    document.getElementById('mode').innerHTML = String(message.mode);
    //uav1statelistener.unsubscribe();
  });

  // UAV State
  var uav1offstatelistener = new ROSLIB.Topic({
    ros : ros,
    name : '/state',
    messageType : 'std_msgs/String'
  });

  uav1offstatelistener.subscribe(function(message) {
    //console.log('Received message on ' + uav1statelistener.name + ': ' + message.mode);
    document.getElementById('off_mode').innerHTML = String(message.data);
    //uav1statelistener.unsubscribe();
  });



</script>

<link rel="stylesheet" href="/style2.css">

  </head>

  
  <body>

    <!-- <h3 class="ui center aligned header">Responsive Vertical Divider</h3> -->

    <!-- style="position: relative" -->
    <div
      class="ui stackable two column grid container"
      style="position: relative"
    >
      <div class="column">
        <div class="ui segment">
          <p class= "left aligned data_text" >UAV1 <span id="ping">ping</span></p>
          <p class="data_text">x: <strong><span id="posx"></span>m</strong></span>-><span id="setx"></span></p>
          <p class="data_text">y: <strong><span id="posy"></span>m</strong></span>-><span id="sety"></span></p>
          <p class="data_text">z: <strong><span id="posz"></span>m</strong></span>-><span id="setz"></span></p>
    
          <p class="data_text">State: <strong><span id="off_mode"></span></strong></span></p>
          <p class="data_text">Flight Mode: <strong><span id="mode"></span></strong></span></p>
          <p class="data_text">Battery: <strong><span id="battery"></span>%</strong></span></p>
        </div>
      </div>
      <div class="column">
        <div class="ui segment"><iframe src="http://localhost:8080/stream?topic=/image_topic_1&type=png" style="width:fit-content; height:40%;"> </iframe></div>
      </div>
    </div>

    <!-- <script type="text/javascript">
      $(document).ready(function () {
        var $headers = $("body > h3"),
          $header = $headers.first(),
          ignoreScroll = false,
          timer;

        // Preserve example in viewport when resizing browser
        $(window).on("resize", function () {
          // ignore callbacks from scroll change
          clearTimeout(timer);
          $headers.visibility("disable callbacks");

          // preserve position
          $(document).scrollTop($header.offset().top);

          // allow callbacks in 500ms
          timer = setTimeout(function () {
            $headers.visibility("enable callbacks");
          }, 500);
        });
        $headers.visibility({
          // fire once each time passed
          once: false,

          // don't refresh position on resize
          checkOnRefresh: true,

          // lock to this element on resize
          onTopPassed: function () {
            $header = $(this);
          },
          onTopPassedReverse: function () {
            $header = $(this);
          },
        });
      });
    </script> -->
  </body>

</html>
